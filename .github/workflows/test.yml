name: Test

on: [push]

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@main

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Run cargo check
        run: cargo check

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout sources
        uses: actions/checkout@master

      - name: Clone eth-testnet-runner repository
        uses: GuillaumeFalourd/clone-github-repo-action@v2
        with:
          owner: "ralexstokes"
          repository: "eth-testnet-runner"

      - name: Fetch geth binary
        run: |
          cd eth-testnet-runner
          mkdir bin
          wget https://gethstore.blob.core.windows.net/builds/geth-linux-amd64-1.11.3-5ed08c47.tar.gz -O ./geth-linux-amd64-1.11.3-5ed08c47.tar.gz
          tar -xvf geth-linux-amd64-1.11.3-5ed08c47.tar.gz
          cd geth-linux-amd64-1.11.3-5ed08c47
          cp geth ../bin

      - name: Fetch lighthouse binary
        run: |
          cd eth-testnet-runner
          wget https://github.com/sigp/lighthouse/releases/download/v3.5.1/lighthouse-v3.5.1-x86_64-apple-darwin-portable.tar.gz -O ./lighthouse-v3.5.1-x86_64-apple-darwin-portable.tar.gz
          tar -xvf lighthouse-v3.5.1-x86_64-apple-darwin-portable.tar.gz
          cp lighthouse ./bin

      - name: Install go
        uses: actions/setup-go@v3
        with:
          go-version: "stable"

      - name: check go version
        run: go version

      - name: Clone eth2-val-tools repo
        uses: GuillaumeFalourd/clone-github-repo-action@v2
        with:
          owner: "protolambda"
          repository: "eth2-val-tools"

      - name: build eth2-val-tools and move binary to eth-testnet-runner bin folder
        run: |
          cd eth2-val-tools
          go build
          cp eth2-val-tools ../eth-testnet-runner/bin

      - name: Install rust stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      # - name: Set UID env variable needed by create-config in the next step
      #   run: |
      #     !#/bin/bash
      #     echo User ID [UID]: $(id -u)
      #     sudo usermod -u $(id -u) $(whoami)

      - name: install just
        run: |
          cargo install just
          cd eth-testnet-runner
          just create-config &

      - name: run generate-keys
        run: |
          cd eth-testnet-runner
          just generate-keys

      - name: run init-geth
        run: |
          cd eth-testnet-runner
          just init-geth

      - name: run run-el
        run: |
          cd eth-testnet-runner
          just run-el &

      - name: Set MIN_GENESIS_TIME to 1 with sed
        run: |
          ls eth-testnet-runner/
          cd eth-testnet-runner/
          ls config-data/
          cd config-data/
          ls custom_config_data/
          cd custom_config_data/
          sed -i 's/^MIN_GENESIS_TIME:.*/MIN_GENESIS_TIME: 1/' config.yaml

      - name: run run-cl
        run: |
          cd eth-testnet-runner
          just run-cl &

      - name: run run-validator
        run: |
          cd eth-testnet-runner
          just run-validator &

      - name: Run all tests
        run: |
          cargo test
